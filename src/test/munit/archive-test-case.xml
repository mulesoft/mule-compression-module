<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
      xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
      xmlns:compression="http://www.mulesoft.org/schema/mule/compression"
      xmlns:file="http://www.mulesoft.org/schema/mule/file"
      xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
      http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
      http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
      http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
      http://www.mulesoft.org/schema/mule/compression http://www.mulesoft.org/schema/mule/compression/current/mule-compression.xsd">

    <munit:config name="archive.xml"/>

    <munit:test name="archive">
        <munit:behavior>
            <file:read config-ref="test-resources" path="file.txt" outputMimeType="text/plain"/>
            <set-variable variableName="file1Size" value="#[attributes.size]"/>
            <set-variable variableName="file1" value="#[payload]"/>
            <logger level="INFO" message="file1size is #[vars.file1Size]"/>
            <file:read config-ref="test-resources" path="file.txt" outputMimeType="text/plain"/>
            <set-variable variableName="file2Size" value="#[attributes.size]"/>
            <set-variable variableName="file2" value="#[payload]"/>
            <logger level="INFO" message="file2size is #[vars.file2Size]"/>
        </munit:behavior>
        <munit:execution>
            <compression:archive>
                <compression:entries><![CDATA[#[output application/java --- {k1: vars.file1, k2: vars.file2}]]]></compression:entries>
                <compression:archiver>
                    <compression:zip-archiver forceZip64="true" />
                </compression:archiver>
            </compression:archive>
            <set-variable variableName="compressed" value="#[payload]"/>
            <file:write config-ref="tmp-dir" path="file-txt.zip"/>
            <file:read config-ref="tmp-dir" path="file-txt.zip"/>
            <set-variable variableName="compressedFileSize" value="#[attributes.size]"/>
            <logger level="INFO" message="compressedFileSize is #[vars.compressedFileSize]"/>
        </munit:execution>
        <munit:validation>
            <munit-tools:assert-that expression="#[vars.file1Size+vars.file2Size]" is="#[MunitTools::greaterThan(vars.compressedFileSize)]"/>
            <munit-tools:assert-that expression="#[vars.compressed]" is="#[MunitTools::withMediaType('application/zip')]"/>
        </munit:validation>
    </munit:test>
</mule>
